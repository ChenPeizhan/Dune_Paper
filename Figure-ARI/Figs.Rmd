---
author: "Hector Roux de BÃ©zieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
title: 'Impact of all the methods on ARI merging'
output:
  html_document:
    toc: true
    toc_float: TRUE
    toc_depth: 2
    number_sections: true
    code_download: TRUE
---

```{r load packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F,
  fig.align = "center", echo = F
)
libs <- c("here", "dplyr", "ggplot2", "tidyr", "stringr", "readr", "cowplot",
          "mclust", "RColorBrewer", "purrr", "Dune", "pracma")
suppressMessages(
  suppressWarnings(sapply(libs, require, character.only = TRUE))
)
rm(libs)
```

# Panel a

```{r}
df <- read.table(here("Figure-ARI", "data", "sc3-comp1.txt"), header = TRUE,
                       stringsAsFactors = FALSE)
p <- ggplot(df, aes(x = n_clus, y = ARI, col = mergeMethod)) +
  geom_line(size = 2) +
  theme_classic() +
  scale_color_brewer(palette = "Dark2")
p
ggsave(plot = p, filename = here("Figure-ARI", "figures", "sc3-example.pdf"))
```

# Panel b

```{r}
df2 <- df %>% filter(mergeMethod == "Dune")
p <- ggplot(df2, aes(x = n_clus, y = ARI)) +
  geom_area(aes(y = ARI), fill = "gray", alpha = .5) +
  geom_line(size = 2, col = "#7570B3") +
  theme_classic() +
  geom_segment(x = min(df2$n_clus), xend = max(df2$n_clus), y = 0, yend = 0) +
  geom_segment(x = min(df2$n_clus), xend = min(df2$n_clus), y = 0,
               yend = df2$ARI[1]) +
  geom_segment(x = max(df2$n_clus), xend = max(df2$n_clus), y = 0,
               yend = df2$ARI[nrow(df2)]) +
  annotate("text", x = (min(df2$n_clus) + max(df2$n_clus)) / 2,
           y = mean(df2$ARI) / 2, label = "Area Under the ARI Curve\n(AUARIC)")
p
ggsave(plot = p, filename = here("Figure-ARI", "figures", "AUARIC.pdf"))
```

# Panel c

```{r}
types <- unique(df$mergeMethod)
names(types) <- types
AUARIC <- map_df(types, function(type){
  df <- df %>% 
    filter(mergeMethod == type) %>%
    arrange(n_clus)
  return(trapz(x = df$n_clus, y = df$ARI))
}) %>%
  t() %>%
  as.data.frame() %>%
  mutate("mergeMethods" = rownames(.)) %>%
  rename(AUARIC = V1) %>%
  select(mergeMethods, AUARIC)
kable(AUARIC)
  
```

# Panel d

For now, this only include the brain data. It will also include the Pancreas data once it is ready

```{r}
# df <- bind_rows(
#   "Brain" = read.table(here("Figure-ARI", "data", "Brain.txt"), header = TRUE,
#                        stringsAsFactors = FALSE),
#   "Pancreas" = read.table(here("Figure-ARI", "data", "Pancreas.txt"),
#                           header = TRUE, stringsAsFactors = FALSE)
#   ) %>%
df <- read.table(here("Figure-ARI", "data", "Brain.txt"), header = TRUE,
                       stringsAsFactors = FALSE) %>%
  mutate(scenario = paste(dataset, method, comp, sep = "_"))
p <- ggplot(df %>% select(scenario, Merge_method, AUARIC) %>%
              group_by(scenario) %>%
              filter(Merge_method != "Param") %>%
              mutate(rk = dense_rank(desc(AUARIC)),
                     rk = as.character(rk)),
            aes(x = scenario, y = Merge_method, fill = rk)) +
  geom_tile() +
  scale_fill_viridis_d() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.line = element_blank()) +
  labs(x = "", y = "")
p
ggsave(plot = p, filename = here("Figure-ARI", "figures", "all_comp.pdf"),
       height = 8)
```

```{r}
p <- ggplot(df %>% select(scenario, Merge_method, AUARIC) %>%
              group_by(scenario) %>%
              # filter(Merge_method != "Param") %>%
              mutate(rk = dense_rank(desc(AUARIC)),
                     rk = as.character(rk)),
            aes(x = scenario, y = Merge_method, fill = rk)) +
  geom_tile() +
  scale_fill_viridis_d() +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90),
        axis.line = element_blank()) +
  labs(x = "", y = "")
ggsave(plot = p, filename = here("Figure-ARI", "figures", "all_comp_param.pdf"),
       height = 8)
```