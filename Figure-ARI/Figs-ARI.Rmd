---
author: "Hector Roux de Bézieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
title: 'Impact of all the methods on ARI merging'
output:
  html_document:
    toc: true
    toc_float: TRUE
    toc_depth: 2
    number_sections: true
    code_download: TRUE
---

```{r load packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F,
  fig.align = "center", echo = F
)
libs <- c("here", "dplyr", "ggplot2", "tidyr", "stringr", "readr", "cowplot",
          "mclust", "RColorBrewer", "purrr", "Dune", "pracma", "kableExtra",
          "DailyHRB")
suppressMessages(
  suppressWarnings(sapply(libs, require, character.only = TRUE))
)
rm(libs)
```

# Panel a

```{r}
df <- read.table(here("Figure-ARI", "data", "sc3-comp1.txt"), header = TRUE,
                       stringsAsFactors = FALSE)
p <- ggplot(df %>% filter(mergeMethod != "Params"),
            aes(x = n_clus, y = ARI, col = mergeMethod)) +
  geom_line(size = 2, alpha = .9,
            arrow = arrow(length = unit(0.30,"cm"), ends = "first", 
                          type = "closed"),
            show.legend = FALSE) +
  geom_line(size = 0, alpha = 0) +
  my_theme() +
  scale_color_brewer(palette = "Dark2") +
  annotate("text", x = max(df$n_clus), y = min(df$ARI) + .025,
           label = "Start", fontface = "bold") +
  labs(x = "Number of clusters", y = "ARI with gold standard",
       col = "Method of\nmerging") +
  scale_x_continuous(breaks = c(20, 25, 30)) +
  guides(color = guide_legend(
    override.aes = list(size = 2, alpha = 1))
  ) +
  theme(legend.position = c(.9, .8),
        legend.title.align = 0.5)
p
ggsave(plot = p, filename = here("Figure-ARI", "figures", "sc3-example.png"),
       bg = "transparent")
```

# Panel b

```{r}
df2 <- df %>% filter(mergeMethod == "Dune")
p <- ggplot(df2, aes(x = n_clus, y = ARI)) +
  geom_ribbon(aes(ymax = ARI), ymin = min(df$ARI) - 5,
              fill = "gray", alpha = .5) +
  geom_line(size = 2, col = "#7570B3") +
  my_theme() +
  geom_segment(x = min(df2$n_clus), xend = max(df2$n_clus), y = 0, yend = 0) +
  geom_segment(x = min(df2$n_clus), xend = min(df2$n_clus), y = 0,
               yend = df2$ARI[1]) +
  geom_segment(x = max(df2$n_clus), xend = max(df2$n_clus), y = 0,
               yend = df2$ARI[nrow(df2)]) +
  annotate("text", x = (min(df2$n_clus) + max(df2$n_clus)) / 2,
           y = .66 * min(df$ARI) + .33 * max(df$ARI),
           label = "Area Under the ARI Curve\n(AUARIC)",
           size = 7) +
  labs(x = "Number of clusters", y = "ARI with gold standard") +
  scale_x_continuous(breaks = c(20, 25, 30)) +
  scale_y_continuous(limits = c(min(df$ARI), max(df$ARI)))
p
ggsave(plot = p, filename = here("Figure-ARI", "figures", "AUARIC.png"),
       bg = "transparent", height = 4.51, width = 7.29)
```

# Panel c

```{r}
types <- unique(df$mergeMethod)
names(types) <- types
AUARIC <- map_df(types, function(type){
  df <- df %>% 
    filter(mergeMethod == type) %>%
    arrange(n_clus)
  return(trapz(x = df$n_clus, y = df$ARI))
}) %>%
  t() %>%
  as.data.frame() %>%
  mutate("mergeMethods" = rownames(.)) %>%
  select(mergeMethods, V1) %>%
  filter(mergeMethods != "Params") %>%
  rename(AUARIC = V1,
         "Methods of\nmerging" = "mergeMethods")
AUARIC$`scaled AUAIRC` <- scale(AUARIC$AUARIC)
  
kableExtra::kable(AUARIC, format = "html", digits = 2) %>%
  kable_styling("striped") %>%
  column_spec(1:2, width = "1cm")
```

# Panel d

For now, this only include the brain data. It will also include the Pancreas data once it is ready

```{r}
df <- bind_rows(
  "Brain" = read.table(here("Figure-ARI", "data", "Brain.txt"), header = TRUE,
                       stringsAsFactors = FALSE),
  "Pancreas" = read.table(here("Figure-ARI", "data", "Pancreas.txt"),
                          header = TRUE, stringsAsFactors = FALSE)
  ) %>%
# df <- read.table(here("Figure-ARI", "data", "Brain.txt"), header = TRUE,
#                        stringsAsFactors = FALSE) %>%
  mutate(scenario = paste0(dataset, "\n", method, "_", comp))
p <- ggplot(df %>% select(scenario, Merge_method, AUARIC) %>%
              group_by(scenario) %>%
              filter(Merge_method != "Param") %>%
              mutate(AUARIC = scale(AUARIC)),
            aes(x = scenario, y = Merge_method, fill = AUARIC)) +
  geom_tile() +
  scale_fill_viridis_c(begin = 0, end = 1) +
  # scale_fill_gradientn(colors = brewer.pal(9, "Spectral")[9:1]) +
  my_theme() +
  theme(axis.text.x = element_text(angle = 90),
        axis.line = element_blank()) +
  labs(x = "", y = "", fill = "Scaled\nAUARIC",
       title = bquote("3 clustering methods × 3" ~ theta[method] ~
                        " × 4 datasets = 36 comparisons")) +
  theme(axis.text.y = element_text(size = 15),
        axis.text.x = element_text(size = 8),
        legend.title = element_text(size = 14, hjust = .5),
        legend.position = "bottom")
p
ggsave(plot = p, filename = here("Figure-ARI", "figures", "all_comp_col2.png"),
       width = 10, height = 4,
       bg = "transparent")
```

```{r}
p <- ggplot(df %>% select(scenario, Merge_method, AUARIC) %>%
              group_by(scenario) %>%
              mutate(rk = scale(AUARIC)),
            aes(x = scenario, y = Merge_method, fill = rk)) +
  geom_tile() +
  scale_fill_viridis_c(begin = 1, end = 0) +
  my_theme() +
  theme(axis.text.x = element_text(angle = 90),
        axis.line = element_blank()) +
  labs(x = "", y = "")
# ggsave(plot = p, filename = here("Figure-ARI", "figures", "all_comp_param.pdf"),
#        width = 10, height = 4)
```