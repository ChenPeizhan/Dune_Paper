---
author: "Hector Roux de BÃ©zieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
title: 'Panel on Dune specificities'
output:
  html_document:
    toc: true
    toc_float: TRUE
    toc_depth: 2
    number_sections: true
    code_download: TRUE
---

```{r load packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F,
  fig.align = "center", echo = F
)
libs <- c("here", "dplyr", "ggplot2", "tidyr", "stringr", "readr", "cowplot",
          "mclust", "RColorBrewer", "purrr", "Dune", "pracma", "purrr",
          "DailyHRB")
suppressMessages(
  suppressWarnings(sapply(libs, require, character.only = TRUE))
)
rm(libs)
```

# Garbage Replicability
## Rep curves

```{r}
df <- read.table(here("Figure-Stability", "data", "garbage.txt")) %>%
  mutate(nb_clusters = (replicable_clusters + non_replicable_clusters) / 2)
p <- ggplot(df %>% arrange(level), 
       aes(x = nb_clusters,
           y = fraction_replicable_cells,
           col = as.character(nb_garb))) +  
  geom_path(size = 2, alpha = .8) +
  theme_classic() +
  facet_wrap(~clustering_name, scales = "free",
             ncol = 1) +
  scale_color_brewer(type = "div") +
  labs(x = "Resolution", y = "Replicability",
       col = "Number\nof\nrandom\ninputs") +
  theme(legend.title = element_text(size = 20),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 10),
        legend.text = element_text(size = 12),
        plot.background = element_blank(),
        legend.background = element_blank(),
        panel.background = element_blank(),
        panel.border = element_blank(),
        legend.box.background = element_blank(),
        strip.background = element_rect(fill = "transparent"))
p
ggsave(filename = here("Figure-Stability", "figures", "garbage_rep.png"),
       plot = p, width = 7, height = 10,
       bg = "transparent")
```

# Garbage ARI

```{r}
df <- read.table(here("Figure-Stability", "data", "garbage_ari.txt"))
p <- ggplot(df, 
       aes(x = x,
           y = ARI,
           col = as.character(nb_garb))) +  
  geom_path(size = 2, alpha = .8) +
  theme_classic() +
  facet_wrap(~ dataset,
             scales = "free",
             ncol = 1) +
  scale_color_brewer(type = "div") +
  labs(x = "Merging Steps", y = "mean ARI between Seurat, Monocle and SC3",
       col = "Number\nof\nrandom\ninputs") +
  theme(legend.title = element_text(size = 20),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 10),
        legend.text = element_text(size = 12),
        plot.background = element_blank(),
        legend.background = element_blank(),
        panel.background = element_blank(),
        panel.border = element_blank(),
        legend.box.background = element_blank(),
        strip.background = element_rect(fill = "transparent"))
p
ggsave(filename = here("Figure-Stability", "figures", "garbage_ari.png"),
       plot = p, width = 7, height = 10,
       bg = "transparent")
```

# Dune's stoppping point is meaningfull

```{r}
mergers <- readRDS(here("Brain", "data", "Dune",
                        "SMARTer_nuclei_MOp_mergers.rds"))
allen_clusters <- read.csv(here("Brain", "data", "Smart-Seq",
                                  "SMARTer_nuclei_MOp_cluster.membership.csv"),
                           col.names = c("cells", "cluster_id"))
clusters <- read.csv(here("Brain", "data", "Smart-Seq",
                          "SMARTer_nuclei_MOp_cluster.annotation.csv"),
                       header = T)
allen_clusters <- full_join(allen_clusters, clusters) %>%
  arrange(cells) %>%
  mutate(cells = as.character(cells)) %>%
  filter(class_label != "Noise") %>%
  arrange(class_label)
allen_clusters$subclass_label <- factor(allen_clusters$subclass_label,
                                levels = unique(allen_clusters$subclass_label))
rm(clusters)

p <- ConfusionPlot(y = mergers$currentMat[allen_clusters$cells, "sc3"],
              x = allen_clusters$subclass_label) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(rect = element_blank()) +
  labs(x = "Allen Subclass Labels", y = "Dune's stopping point")
p
ggsave(filename = here("Figure-Stability", "figures", "Stoppping_Point.png"),
       plot = p, bg = "transparent")
```

# Stability to inputs

```{r}
df <- bind_rows(
  read.table(here("Figure-Stability", "data", "Brain-methods.txt"),
             header = TRUE),
  read.table(here("Figure-Stability", "data", "Pancreas-methods.txt"),
             header = TRUE)
)
df <- df %>% 
  pivot_longer(-c("steps", "dataset"), names_to = "methods",
               values_to = "meanARI") %>%
  group_by(dataset, methods) %>%
  arrange(steps) %>%
  summarise(begin = first(meanARI),
            end = last(meanARI)) %>%
  group_by(dataset) %>%
  summarise(begin = mean(begin), end = mean(end))

```