---
author: "Hector Roux de BÃ©zieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
title: 'Panel on Dune specificities'
output:
  html_document:
    toc: true
    toc_float: TRUE
    toc_depth: 2
    number_sections: true
    code_download: TRUE
---

```{r load packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F,
  fig.align = "center", echo = F
)
libs <- c("here", "dplyr", "ggplot2", "tidyr", "stringr", "readr", "cowplot",
          "mclust", "RColorBrewer", "purrr", "Dune", "pracma", "purrr",
          "DailyHRB")
suppressMessages(
  suppressWarnings(sapply(libs, require, character.only = TRUE))
)
rm(libs)
```

# Garbage Replicability

```{r}
df <- read.table(here("Figure-Stability", "data", "garbage.txt")) %>%
  mutate(nb_clusters = (replicable_clusters + non_replicable_clusters) / 2) %>%
  group_by(Comp, rep, nb_garb, clustering_name) %>%
  arrange(level) %>%
  summarise(AUC = -trapz(x = nb_clusters, y = fraction_replicable_clusters)) %>%
  ungroup() %>%
  group_by(Comp, nb_garb, clustering_name) %>%
  summarise(AUC = mean(AUC)) %>%
  ungroup() %>%
  group_by(Comp, clustering_name) %>%
  arrange(nb_garb) %>%
  mutate(AUC = AUC / first(AUC)) %>%
  identity()
p1 <- ggplot(df, aes(x = nb_garb, y = 100 * AUC, group = nb_garb)) +
  geom_boxplot() +
  my_theme() +
  scale_y_continuous(limits = c(80, 120), 
                     breaks = 8:12 * 10,
                     labels = paste(8:12 * 10, "%")) +
  labs(x = "Number of random inputs",
       y = "Ratio of AUC over AUC with no random inputs") +
  # theme() +
  NULL
p1
ggsave(filename = here("Figure-Stability", "figures", "garbage.png"),
       bg = "transparent", plot = p1)
```

# Dune's stoppping point is meaningfull

```{r}
mergers <- readRDS(here("Brain", "data", "Dune",
                        "SMARTer_nuclei_MOp_mergers.rds"))
allen_clusters <- read.csv(here("Brain", "data", "Smart-Seq",
                                  "SMARTer_nuclei_MOp_cluster.membership.csv"),
                           col.names = c("cells", "cluster_id"))
clusters <- read.csv(here("Brain", "data", "Smart-Seq",
                          "SMARTer_nuclei_MOp_cluster.annotation.csv"),
                       header = T)
allen_clusters <- full_join(allen_clusters, clusters) %>%
  arrange(cells) %>%
  mutate(cells = as.character(cells)) %>%
  filter(class_label != "Noise") %>%
  arrange(class_label)
allen_clusters$subclass_label <- factor(allen_clusters$subclass_label,
                                levels = unique(allen_clusters$subclass_label))
rm(clusters)

p <- ConfusionPlot(y = mergers$currentMat[allen_clusters$cells, "sc3"],
              x = allen_clusters$subclass_label) +
  theme(axis.text.x = element_text(angle = 90)) +
  theme(rect = element_blank()) +
  labs(x = "Allen Subclass Labels", y = "Dune's stopping point")
p
ggsave(filename = here("Figure-Stability", "figures", "Stoppping_Point.png"),
       plot = p, bg = "transparent")
```

# Stability to downsampling



# Stability to inputs

```{r}
df <- bind_rows(
  read.table(here("Figure-Stability", "data", "Brain-methods.txt"),
             header = TRUE),
  read.table(here("Figure-Stability", "data", "Pancreas-methods.txt"),
             header = TRUE)
)
df <- df %>% 
  pivot_longer(-c("steps", "dataset"), names_to = "methods",
               values_to = "meanARI") %>%
  group_by(dataset, methods) %>%
  arrange(steps) %>%
  summarise(begin = first(meanARI),
            end = last(meanARI)) %>%
  group_by(dataset) %>%
  summarise(begin = mean(begin), end = mean(end))

```