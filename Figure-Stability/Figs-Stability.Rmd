---
author: "Hector Roux de BÃ©zieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
title: 'Panel on Dune specificities'
output:
  html_document:
    toc: true
    toc_float: TRUE
    toc_depth: 2
    number_sections: true
    code_download: TRUE
---

```{r load packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F,
  fig.align = "center", echo = F
)
libs <- c("here", "dplyr", "ggplot2", "tidyr", "stringr", "readr", "cowplot",
          "mclust", "RColorBrewer", "purrr", "Dune", "pracma", "purrr",
          "DailyHRB")
suppressMessages(
  suppressWarnings(sapply(libs, require, character.only = TRUE))
)
rm(libs)
```

# Garbage Replicability
## Rep curves

```{r}
df <- read.table(here("Figure-Stability", "data", "garbage.txt")) %>%
  mutate(nb_clusters = (replicable_clusters + non_replicable_clusters) / 2)
p <- ggplot(df %>% arrange(level), 
       aes(x = nb_clusters,
           y = fraction_replicable_cells,
           col = as.character(nb_garb))) +  
  geom_path(size = 2, alpha = .8) +
  theme_classic() +
  facet_wrap(~clustering_name, scales = "free",
             ncol = 1) +
  scale_color_brewer(type = "div") +
  labs(x = "Resolution", y = "Replicability",
       col = "Number\nof\nrandom\ninputs") +
  theme(legend.title = element_text(size = 20),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 10),
        legend.text = element_text(size = 12),
        plot.background = element_blank(),
        legend.background = element_blank(),
        panel.background = element_blank(),
        panel.border = element_blank(),
        legend.box.background = element_blank(),
        strip.background = element_rect(fill = "transparent"))
p
ggsave(filename = here("Figure-Stability", "figures", "garbage_rep.png"),
       plot = p, width = 7, height = 10,
       bg = "transparent")
```

## AUC

```{r}
AUC <- df %>%
  group_by(clustering_name, nb_garb) %>%
  summarise(AUC = -trapz(x = nb_clusters, y = fraction_replicable_cells)) %>%
  ungroup() %>% 
  group_by(clustering_name) %>%
  arrange(nb_garb) %>%
  mutate(AUC = AUC / first(AUC))
ggplot(AUC, aes(x = nb_garb, y = AUC, col = clustering_name)) +
  geom_line() +
  theme_classic()
```

# Garbage ARI

```{r}
df <- read.table(here("Figure-Stability", "data", "garbage_ari.txt"))
p <- ggplot(df, 
       aes(x = x,
           y = ARI,
           col = as.character(nb_garb))) +  
  geom_path(size = 2, alpha = .8) +
  theme_classic() +
  facet_wrap(~ dataset,
             scales = "free",
             ncol = 1) +
  scale_color_brewer(type = "div") +
  labs(x = "Merging Steps", y = "mean ARI between Seurat, Monocle and SC3",
       col = "Number\nof\nrandom\ninputs") +
  theme(legend.title = element_text(size = 20),
        axis.title = element_text(size = 15),
        axis.text = element_text(size = 10),
        legend.text = element_text(size = 12),
        plot.background = element_blank(),
        legend.background = element_blank(),
        panel.background = element_blank(),
        panel.border = element_blank(),
        legend.box.background = element_blank(),
        strip.background = element_rect(fill = "transparent"))
p
ggsave(filename = here("Figure-Stability", "figures", "garbage_ari.png"),
       plot = p, width = 7, height = 10,
       bg = "transparent")
```

# Dune's stoppping point.

```{r}