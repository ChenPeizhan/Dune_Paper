---
author: "Hector Roux de BÃ©zieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
title: "Dune's inner workings"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: TRUE
    number_sections: true
    code_download: TRUE
---

We use a subset of the Allen Smart-Seq nuclei dataset. Run `?Dune::nuclei` for more details on pre-processing.

```{r setup}
suppressPackageStartupMessages({
  library(RColorBrewer)
  library(dplyr)
  library(ggplot2)
  library(tidyr)
  library(knitr)
  library(purrr)
  library(Dune)
  library(here)
})
data("nuclei", package = "Dune")
theme_set(theme_classic())
```

# Initial visualization

We can also see how the three clustering algorithm partitioned the dataset initially:

```{r}
nuclei <- nuclei %>% filter(SC3 != 4, SC3 != 24)
cols <- brewer.pal(n = n_distinct(nuclei$SC3), name = "Dark2")
names(cols) <- unique(nuclei$SC3)
p <- ggplot(nuclei, aes(x = x, y = y, col = as.character(SC3))) +
  geom_point(size = .5) +
  guides(color = FALSE) +
  labs(title = "SC3") +
  scale_color_manual(values = cols)
p
ggsave(here("Figure-Diagram", "figures", "Init-SC3.pdf"),
       p, height = 3, width = 5)
```

The adjusted Rand Index between the three methods can be computed.

```{r}
plotARIs(nuclei %>% select(SC3, Seurat, Monocle))
ggsave(filename = here("Figure-Diagram", "figures", "Init-ARI.pdf"),
       height = 7, width = 7,
       plot = plotARIs(nuclei %>% select(SC3, Seurat, Monocle)))
```

As we can see, the ARI between the three methods is initially quite low.

```{r}
p <- ConfusionPlot(nuclei$SC3, nuclei$Monocle) +
  labs(x = "SC3", y = "Monocle")
p
ggsave(plot = p, width = 5, height = 3,
       filename = here("Figure-Diagram", "figures", "Init-Confusion.pdf"))
```


# Merging one cluster

```{r}
pOG <- ConfusionPlot(nuclei$SC3, nuclei$Monocle) +
  labs(x = "SC3", y = "Monocle")
SC3 <- nuclei$SC3
df <- nuclei
SC3[SC3 %in% c(21, 20)] <- 20
df$SC3 <- SC3

p <- ggplot(df, aes(x = x, y = y, col = as.character(SC3))) +
  geom_point(size = .5) +
  guides(color = FALSE) +
  labs(title = "SC3") +
  scale_color_manual(values = cols)  
p
ggsave(here("Figure-Diagram", "figures", "OneMerge-SC3.pdf"),
         p, height = 3, width = 5)
p <- ConfusionPlot(df$SC3, df$Monocle) +
  labs(x = "SC3", y = "Monocle") +
  scale_x_discrete(limits = levels(pOG$data$x)) +
  scale_y_discrete(limits = levels(pOG$data$y))
p
ggsave(plot = p, width = 5, height = 3,
       filename = here("Figure-Diagram", "figures", "OneMerge-Confusion.pdf"))

plotARIs(df %>% select(SC3, Seurat, Monocle))
ggsave(filename = here("Figure-Diagram", "figures", "OneMerge-ARI.pdf"),
       height = 7, width = 7,
       plot = plotARIs(df %>% select(SC3, Seurat, Monocle)))
```

## Actual merging

```{r}
clusMat <- nuclei %>% select(SC3, Seurat, Monocle)
rownames(clusMat) <- nuclei$cells
merger <- Dune(clusMat = clusMat, verbose = TRUE, keepAll = TRUE)
```

## ARI improvement

We can now see how much the ARI has improved:

```{r}
df <- merger$currentMat %>%
  mutate(cells = rownames(merger$currentMat)) %>%
  full_join(nuclei %>% select(x, y, cells))
p <- ggplot(df,
            aes(x = x, y = y, col = as.character(SC3))) +
  geom_point(size = .5) +
  guides(color = FALSE) +
  labs(title = "SC3") +
  scale_color_manual(values = cols)  
p
ggsave(here("Figure-Diagram", "figures", "AllMerge-SC3.pdf"),
         p, height = 3, width = 5)
p <- ConfusionPlot(df$SC3, df$Monocle) +
  labs(x = "SC3", y = "Monocle") +
  scale_x_discrete(limits = levels(pOG$data$x)) +
  scale_y_discrete(limits = levels(pOG$data$y))
p
ggsave(plot = p, width = 5, height = 3,
       filename = here("Figure-Diagram", "figures", "AllMerge-Confusion.pdf"))

plotARIs(df %>% select(SC3, Seurat, Monocle))
ggsave(filename = here("Figure-Diagram", "figures", "AllMerge-ARI.pdf"),
       height = 7, width = 7,
       plot = plotARIs(df %>% select(SC3, Seurat, Monocle)))
```

```{r, eval = FALSE}
ARI <- ARIImp(merger)
df <- data.frame(step = 0:length(merger$ImpARI),
                 ARI = ARI)
p <- ggplot(df, aes(x = step, y = ARI)) +
  geom_path(size = 2) +
  scale_x_continuous(breaks = c(0, length(merger$ImpARI)),
                       labels = c("Initial", "Final"))  +
  theme_classic() +
  theme(rect = element_blank()) +
  labs(x = "Merging steps", y = "mean ARI between partitions")
ggsave(plot = p, width = 7, height = 7,
       filename = here("Figure-Diagram", "figures", "ARI-Imp.pdf"))
```

```{r, eval = FALSE}
baseMat <- merger$initialMat
n_clus <- lapply(1:nrow(merger$merges), function(m){
  diff <- rep(0, ncol(baseMat))
  diff[merger$merges[m, 1]] <- -1
  matrix(diff, nrow = 1)
  }) %>%
    do.call('rbind', args = .)
n_clus <- rbind(apply(baseMat, 2, n_distinct) %>% matrix(data = ., nrow = 1),
                n_clus)
n_clus <- apply(n_clus, 2, cumsum)
colnames(n_clus) <- colnames(merger$initialMat)
df <- data.frame(step = 0:length(merger$ImpARI),
                 n_clus) %>%
  pivot_longer(-step, values_to = "n_clus", names_to = "Partition")
p <- ggplot(df,
            aes(x = step, y = n_clus, col = Partition, group = Partition)) +
  geom_path(size = 2, alpha = .7) +
  scale_x_continuous(breaks = c(0, length(merger$ImpARI)),
                       labels = c("Initial", "Final"))  +
  theme_classic() +
  theme(rect = element_blank()) +
  labs(x = "Merging steps", y = "Number of clusters", col = "") +
  scale_color_brewer(palette = "Set1") +
  guides(col = guide_legend(override.aes = list(alpha = 1))) +
  theme(legend.position = c(.85, .8),
        legend.title.align = 0.5)
ggsave(plot = p23, width = 6, height = 2 * 7 / 3,
       filename = here("Figure-Dune", "figures", "number_clusters.png"),
       bg = "transparent")
p23
```