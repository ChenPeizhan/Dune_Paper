---
author: "Hector Roux de BÃ©zieux"
date: '`r format(Sys.time(), "%d %B , %Y")`'
title: "Dune's inner workings"
output:
  html_document:
    toc: true
    toc_depth: 2
    toc_float: TRUE
    number_sections: true
    code_download: TRUE
---

```{r load packages, include=F}
library(knitr)
opts_chunk$set(
  fig.pos = "!h", out.extra = "", warning = F, message = F,
  fig.width = 5, fig.align = "center", echo = F
)
libs <- c("here", "dplyr", "ggplot2", "tidyr", "stringr", "readr", "cowplot",
          "clusterExperiment", "mclust", "RColorBrewer", "Dune", "purrr")
suppressMessages(
  suppressWarnings(sapply(libs, require, character.only = TRUE))
)
rm(libs)
mergers <- readRDS(here("Brain", "data", "Dune",
                        "SMARTer_cells_MOp_mergers.rds"))
```

# Initial confusion matrices

```{r}
p1 <- ConfusionPlot(mergers$initialMat[, c("sc3", "Monocle")]) +
  labs(x = "SC3", y = "Monocle") +
  scale_color_gradientn(colours = brewer.pal(11, "Spectral"),
                        limits = c(0, 1)) +
  scale_size_continuous(breaks = c(100, 200, 300, 400, 600))
legend_common <- get_legend(
  p1 +
    theme(legend.position = "right") +
    guides(size = guide_legend(title.position = "top", fill = "grey", ncol = 1),
           col = guide_colourbar(title.position = "top"))
  )
legend_common <- plot_grid(legend_common)
ggsave(plot = legend_common,
       filename = here("Figure-Dune", "figures", "legend.pdf"))
p1 <- p1 +
  guides(col = FALSE, size = FALSE)
p1
ggsave(plot = p1, filename = here("Figure-Dune", "figures",
                                  "confusion_plot_before_1.pdf"))
p2 <- ConfusionPlot(mergers$initialMat[, c("sc3", "Seurat")]) +
  labs(x = "SC3", y = "Seurat") +
  guides(col = FALSE, size = FALSE) +
  scale_color_gradientn(colours = brewer.pal(11, "Spectral"),
                        limits = c(0, 1)) +
  scale_size_continuous(breaks = c(100, 200, 300, 400, 600))
p2
ggsave(plot = p2, filename = here("Figure-Dune", "figures",
                                  "confusion_plot_before_2.pdf"))
p3 <- ConfusionPlot(mergers$initialMat[, c("Seurat", "Monocle")]) +
  labs(x = "Seurat", y = "Monocle") +
  guides(col = FALSE, size = FALSE) +
  scale_color_gradientn(colours = brewer.pal(11, "Spectral"),
                        limits = c(0, 1)) +
  scale_size_continuous(breaks = c(100, 200, 300, 400, 600))
p3
ggsave(plot = p3, filename = here("Figure-Dune", "figures",
                                  "confusion_plot_before_3.pdf"))
rm(p1, p2, p3)
```

# Improvement in ARI

```{r ARI imp no allen cell}
p1 <- plotARIs(mergers$initialMat) + ggtitle("ARI matrix before Merging") +
  labs(x = "", y = "") +
  theme(plot.title = element_text(hjust = 0.5))
p1
ggsave(plot = p1, filename = here("Figure-Dune", "figures", 
                                  "ARI_Matrix_Before.pdf"))
p2 <- plotARIs(mergers$currentMat) + ggtitle("ARI matrix after Merging") +
  labs(x = "", y = "") +
  theme(plot.title = element_text(hjust = 0.5))
p2
ggsave(plot = p2, filename = here("Figure-Dune", "figures", 
                                  "ARI_Matrix_After.pdf"))
```

# Trend of ARI improvements and number of clusters
```{r ARI trend, fig.width=9}
ARItrend(merger = mergers) +
  theme(text = element_text(size = 25))
```

# Confusion matrices after merging

```{r}
p1 <- ConfusionPlot(mergers$currentMat[, c("sc3", "Monocle")]) +
  labs(x = "Sc3", y = "Monocle") +
  guides(col = FALSE, size = FALSE) +
  scale_color_gradientn(colours = brewer.pal(11, "Spectral"),
                        limits = c(0, 1)) +
  scale_size_continuous(breaks = c(100, 200, 300, 400, 600))
p1
ggsave(plot = p1, filename = here("Figure-Dune", "figures",
                                  "confusion_plot_after_1.pdf"))
p2 <- ConfusionPlot(mergers$currentMat[, c("sc3", "Seurat")]) +
  labs(x = "Sc3", y = "Seurat") +
  guides(col = FALSE, size = FALSE) +
  scale_color_gradientn(colours = brewer.pal(11, "Spectral"),
                        limits = c(0, 1)) +
  scale_size_continuous(breaks = c(100, 200, 300, 400, 600))
p2
ggsave(plot = p2, filename = here("Figure-Dune", "figures",
                                  "confusion_plot_after_2.pdf"))
p3 <- ConfusionPlot(mergers$currentMat[, c("Seurat", "Monocle")]) +
  labs(x = "Seurat", y = "Monocle") +
  guides(col = FALSE, size = FALSE) +
  scale_color_gradientn(colours = brewer.pal(11, "Spectral"),
                        limits = c(0, 1)) +
  scale_size_continuous(breaks = c(100, 200, 300, 400, 600))
p3
ggsave(plot = p3, filename = here("Figure-Dune", "figures",
                                  "confusion_plot_after_3.pdf"))
rm(p1, p2, p3)
```